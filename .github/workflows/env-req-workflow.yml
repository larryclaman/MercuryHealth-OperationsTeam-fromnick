name: Environment Creation Workflow
on:
  issues:
    types: [labeled]

# optional:  set the resource group to use for the deployment
# if not set, then the workflow will use the RG provided in the form
#env:
#  RG: GHMercuryHealth

jobs:
  parse:
    name: ParseEnvironment
    runs-on: ubuntu-latest
    outputs:
      outputapproved: ${{steps.parser.outputs.approved}}
      outputpolicy: ${{steps.parser.outputs.applyPolicy}}
      outputappname: ${{steps.parser.outputs.appName}}
    steps:
      - uses: actions/checkout@v1
      - uses: nkpatterson/MercuryHealth-Actions/.github/actions/env-req-parser@master
        id: parser
      - run: |
          echo ${{steps.parser.outputs.approved}}
          echo ${{steps.parser.outputs.applyPolicy}}
          echo ${{steps.parser.outputs.appName}}

  build:
      name: EnvironmentCreation
      runs-on: ubuntu-latest
      needs: parse
      if:  needs.parse.outputs.outputapproved
      steps:
      - uses: actions/checkout@v1
      - name: set RG env variable
        if:  true && ! env.RG
        run: echo '::set-env name=RG::${{needs.parse.outputs.outputappname}}'-rg

      - run: echo "Resource Group for deployment is $RG"

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.MercuryHealthGitHubActionsSP }}

      - uses: azure/CLI@v1
        with:
          inlineScript: |
            az group create -n $RG -l ${{ secrets.DefaultAzureLocation }}
            az deployment group create -n AzDoDeploy -g $RG \
               --template-file $GITHUB_WORKSPACE/templates/${{ steps.parser.outputs.armTemplate }}/azuredeploy.json \
               --parameters name=${{ steps.parser.outputs.appName }} password=${{ secrets.DefaultPassword }}


      - uses: azure/CLI@v1
        if: needs.parse.outputs.outputpolicy
        with:
          inlineScript: |
             az policy assignment create -n "${{ steps.parser.outputs.policyName }}" \
                 -g $RG -d $(az policy set-definition list --query "[?contains(displayName,'${{ steps.parser.outputs.policyName }}')].name" -o tsv) \
                 -l ${{ secrets.DefaultAzureLocation }} --assign-identity

      - uses: peter-evans/create-or-update-comment@v1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### ðŸš€All Set! ðŸš€
            Check your Azure Subscription for Resource Group: **${{ steps.parser.outputs.appName }}-rg**
          reaction-type: hooray
